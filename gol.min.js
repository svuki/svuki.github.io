var patterns={backrake_1:"x = 27, y = 18, rule = B3/S23\n5b3o11b3o5b$4bo3bo9bo3bo4b$3b2o4bo7bo4b2o3b$2bobob2ob2o5b2ob2obobo2b$b\n2obo4bob2ob2obo4bob2ob$o4bo3bo2bobo2bo3bo4bo$12bobo12b$2o7b2obobob2o7b\n2o$12bobo12b$6b3o9b3o6b$6bo3bo9bo6b$6bobo4b3o11b$12bo2bo4b2o5b$15bo11b\n$11bo3bo11b$11bo3bo11b$15bo11b$12bobo!",pi_wave:"x = 45, y = 29, rule = B3/S23\n4bo17bo17bo$3bobo15bobo15bobo$3bobo15bobo15bobo$3bobo15bobo15bobo4$3bo\nbo15bobo15bobo2$2bo3bo13bo3bo13bo3bo$3b3o15b3o15b3o4$b2o3b2o11b2o3b2o\n11b2o3b2o$bo5bo11bo5bo11bo5bo$2b5o13b5o13b5o$2bobobo13bobobo13bobobo$b\no5bo11bo5bo11bo5bo$bob3obo11bob3obo11bob3obo$bo5bo11bo5bo11bo5bo$4bo\n17bo17bo$4bo17bo17bo$4bo17bo17bo4$o7bo9bo7bo9bo7bo$o7bo9bo7bo9bo7bo!",
spaceship:"x = 35, y = 19, rule = b3/s23\n33bob$16bo15bobo$6bobo6bo5b2o8bo3b$6bo4bo4bob6o4b2o5b$6bob8o10bo2bob3o\nb$9bo5bo7b4o4b3ob$4b2o17b3obo7b$bo2b2o7b2o8b2o10b$bo2bo30b$o34b$bo2bo\n30b$bo2b2o7b2o8b2o10b$4b2o17b3obo7b$9bo5bo7b4o4b3ob$6bob8o10bo2bob3ob$\n6bo4bo4bob6o4b2o5b$6bobo6bo5b2o8bo3b$16bo15bobo$33bo!"};function chunk(a,b){for(var c=[],d=0;d+b<=a.length;)c.push(a.slice(d,d+b)),d+=b;d!=a.length&&c.push(a.slice(d,a.length));return c}
function flatten(a){return a.reduce(function(a,c){return a.concat(c)},[])}function pad(a,b,c){b=Array.from({length:c-a.length}).fill(b);return a.concat(b)}function flatmap(a,b){return a.reduce(function(a,d){return a.concat(b(d))},[])}function mapmap(a,b){return a.map(function(a,d){return a.map(function(c,g){return b(c,d,g,a)})})}function arr_sum(a){return a.reduce(function(a,c){return a+c})}
function range(a,b){return b?Array.from({length:b-a},function(b,d){return d+a}):Array.from({length:a},function(a,b){return b})}
var gol_canvas_id="#gol-canvas",pattern_canvas_id="#pattern_canvas",rle_textarea_id="#rle_textarea",makeObservable=function(){var a={notify:function(a){this[a].forEach(function(b){return b.update(a)})},get:function(a,c,d){var b=this;return"addObserver"===c?function(c,d){if(c in b)b[c].push(d);else if(c in a)b[c]=[d];else throw"Error: attempted to observe nonexistent property: "+c;}:"removeObserver"===c?function(a,c){if(a in b)b[a]=b[a].filter(function(a){return a!==c});else throw"Error: attempted to remove observer from nonexistent property: "+
a;}:"notify"===c?function(a){b.notify(a)}:a[c]},set:function(a,c,d){c in this?(a[c]=d,this.notify(c)):(this[c]=[],a[c]=d);return!0}};return function(b){b=void 0===b?{}:b;var c=Object.create(a);return new Proxy(b,c)}}();
function RateController(a,b){var c=this;this.handle=void 0;this.rate=void 0===a?1E3:a;this.f=b;this.set_f=function(a){return c.f=a};this.set_rate=function(a){this.rate=a;this.is_on()&&(this.off(),this.on())};this.on=function(){var a=this;window.clearInterval(this.handle);this.handle=window.setInterval(function(){return a.f()},this.rate)};this.off=function(){window.clearInterval(this.handle);this.handle=void 0};this.toggle=function(){return void 0===c.handle?c.on():c.off()};this.is_on=function(){return void 0!==
c.handle}}
function TDArray(a,b,c,d){b=void 0===b?a:b;d=void 0===d?!1:d;var f=[];for(i=0;i<a;i++)f.push(Array(b).fill(0));c&&(f=mapmap(f,function(a,b,d){return c(b,d)}));var g=d?function(b){return(b+a)%a}:function(a){return a},h=d?function(a){return(a+b)%b}:function(a){return a};this.wrap=d;this.rows=a;this.cols=b;this.show=function(){return console.log(f)};this.at=function(a,b){return d?f[g(a)][h(b)]:0>a||a>=this.rows||0>b||b>=this.cols?0:f[a][b]};this.set=function(a,b,c){return f[g(a)][h(b)]=c};this.sum=function(){return f.reduce(function(a,
b){return a+arr_sum(b)},0)};this.row=function(a){return f[g(a)]};this.col=function(a){return f.map(function(b){return b[h(a)]})};this.as_array=function(){return f.reduce(function(a,b){return a.concat(b)},[])};this.row_map=function(a){return f.map(a)}}TDArray.prototype.map=function(a){var b=this;return new TDArray(this.rows,this.cols,function(c,d){return a(b.at(c,d),c,d,b)},this.wrap)};TDArray.prototype.copy=function(){return this.map(function(a){return a})};
TDArray.prototype.for_each=function(a){for(i=0;i<this.rows;i++)for(j=0;j<this.cols;j++)a(this.at(i,j),i,j)};TDArray.prototype.rect=function(a,b,c,d){var f=this;if(c<a)return this.rect(c,b,a,d);if(d<b)return this.rect(a,d,c,b);var g=range(a,c+1),h=range(b,d+1),l=g.map(function(a){return h.map(function(b){return f.at(a,b)})});return new TDArray(c-a+1,d-b+1,function(a,b){return l[a][b]},this.wrap)};TDArray.prototype.nbhood=function(a,b,c,d){d=void 0===d?c:d;return this.rect(a-c,b-d,a+c,b+d)};
TDArray.prototype.merge=function(a,b,c){var d=this;b=void 0===b?0:b;c=void 0===c?0:c;b=range(b,b+a.rows);var f=range(c,c+a.cols);b.forEach(function(b,c){return f.forEach(function(f,g){return d.set(b,f,a.at(c,g))})})};TDArray.prototype.transpose=function(){var a=this;return new TDArray(this.cols,this.rows,function(b,c){return a.at(c,b)})};function GameState(a){this.cells=a}function GameStateFromCanvas(a,b){b=void 0===b?1:b;return newEmptyGameState(a.height/b,a.width/b)}
function newEmptyGameState(a,b){return new GameState(new TDArray(a,b,function(){return 0},!1))}GameState.prototype.toggle=function(a,b){var c=0===this.cells.at(a,b)?1:0,d=this.cells.copy();d.set(a,b,c);return new GameState(d)};GameState.prototype.clear=function(){return new GameState(this.cells.map(function(){return 0}))};GameState.prototype.copy=function(){return new GameState(this.cells.copy())};
GameState.prototype.soup=function(){return new GameState(this.cells.map(function(){return.5<Math.random()?1:0}))};GameState.prototype.merge=function(a,b,c){b=void 0===b?0:b;c=void 0===c?0:c;var d=this.cells.copy();d.merge(a.cells,b,c);return new GameState(d)};GameState.prototype.map=function(a){return new GameState(this.cells.map(a))};
function Rule(a){var b=a.match("[B,b](.*)/[S,s](.*$)");this.b=b[1].split("").map(function(a){return parseInt(a,10)});this.s=b[2].split("").map(function(a){return parseInt(a,10)});this.string=a}var classic_rule=new Rule("B3/S23");function rule_fn(a){return function(b,c,d,f){c=f.nbhood(c,d,1,1).sum()-b;return 0===b&&a.b.includes(c)?1:1===b&&a.s.includes(c)?1:0}}function apply_rule(a,b){return b.map(rule_fn(a))}function i_to_y(a,b,c){return function(d){return(d-a)*c+b}}
function j_to_x(a,b,c){return function(d){return(d-a)*c+b}}function y_to_i(a,b,c){return function(d){return Math.floor((d-b)/c+a)}}function x_to_j(a,b,c){return function(d){return Math.floor((d-b)/c+a)}}function calculate_rectangle(a,b,c){var d=a.height/c;a=a.width/c;var f=b.cells.rows;b=b.cells.cols;var g=(f-d)/2,h=(b-a)/2;return{i_0:Math.ceil(g),j_0:Math.ceil(h),i_1:Math.ceil(f-g),j_1:Math.ceil(b-h),y_offset:(d-Math.floor(d))/2*c,x_offset:(a-Math.floor(a))/2*c}}
function Coordinate_handler(a,b,c){this.x_j=this.y_i=this.j_x=this.i_y=this.cell_size=this.rectangle=void 0;this.resize=function(c){this.cell_size=c;c=this.rectangle=calculate_rectangle(a,b,this.cell_size);this.i_y=i_to_y(c.i_0,c.y_offset,this.cell_size);this.j_x=j_to_x(c.j_0,c.x_offset,this.cell_size);this.y_i=y_to_i(c.i_0,c.y_offset,this.cell_size);this.x_j=x_to_j(c.j_0,c.x_offset,this.cell_size)};this.resize(c)}var colors={0:"white",1:"black"};
function draw_cell_xy(a,b,c,d,f){a.fillStyle=colors[c];a.fillRect(d,f,b,b)}function auto_cell_size(a,b){return Math.floor(a.width/Math.max(b.cells.rows,b.cells.cols))}
function Projector(a){var b=a.getContext("2d"),c=void 0,d=void 0,f=void 0,g=void 0,h=void 0,l=!1;this.initialize=function(a,b){c=a.copy();this.resize(b)};this.whipe=function(){b.clearRect(0,0,a.width,a.height);l=!0};this.project=function(a){var k=f;if(l)for(l=!1,i=k.i_0;i<=k.i_1;i++)for(j=k.j_0;j<=k.j_1;j++)draw_cell_xy(b,d,a.cells.at(i,j),h(j),g(i));else for(i=k.i_0;i<=k.i_1;i++)for(j=k.j_0;j<=k.j_1;j++)c.cells.at(i,j)!==a.cells.at(i,j)&&draw_cell_xy(b,d,a.cells.at(i,j),h(j),g(i));c=a.copy()};this.resize=
function(a,b){b=void 0===b?c:b;d=a.cell_size;g=a.i_y;h=a.j_x;f=a.rectangle;this.whipe();this.project(b)}}function draw_line(a,b,c,d,f){a.beginPath();a.moveTo(b,c);a.lineTo(d,f);a.stroke()}function draw_horizontal_lines(a,b,c){var d=a.getContext("2d");range(Math.ceil(a.height/c)).forEach(function(f){return draw_line(d,0,b+f*c,a.width,b+f*c)})}function draw_vertical_lines(a,b,c){var d=a.getContext("2d");range(Math.ceil(a.width/c)).forEach(function(f){return draw_line(d,b+f*c,0,b+f*c,a.height)})}
function Grid(a,b){var c=this;b=void 0===b?10:b;var d=a.getContext("2d");d.lineWidth=.5;var f=!1;this.cell_size=b;this.project_grid=function(){var b=a.height/this.cell_size,c=a.width/this.cell_size;b=(b-Math.floor(b))/2*this.cell_size;c=(c-Math.floor(c))/2*this.cell_size;d.lineWidth=.5;draw_horizontal_lines(a,b,this.cell_size);draw_vertical_lines(a,c,this.cell_size);f=!0};this.clear_grid=function(){d.clearRect(0,0,a.width,a.height);f=!1};this.toggle=function(){f?(c.clear_grid(),f=!1):(c.project_grid(),
f=!0)};this.redraw=function(){c.clear_grid();c.project_grid()};this.resize=function(a){if(0>=a)throw"Grid.resize passed negative or 0 cell_size";c.cell_size=a;f&&c.redraw()}}
function Canvas_set(a,b){var c=this;b=void 0===b?10:b;this.under_canvas=$(a).get(0);if(void 0===this.under_canvas)throw"Error: Canvas_set passed invalid canvas-id: "+a;var d=document.createElement("canvas");d.height=this.under_canvas.height;d.width=this.under_canvas.width;$(d).css("position","absolute");$(d).css("top",$(a).css("top"));$(d).css("left",$(a).css("left"));$(d).css("z-index",1+parseInt($(a).css("z-index")));this.under_canvas.after(d);this.over_canvas=d;this.get_gamestate=this.set_gamestate=
void 0;this.projector=new Projector(this.under_canvas);this.grid=new Grid(this.over_canvas,b);this.coordinate_handler=void 0;this.initialize=function(a,b,c,d){this.set_gamestate=d;this.get_gamestate=c;this.coordinate_handler=new Coordinate_handler(this.under_canvas,a,b);this.projector.initialize(a,this.coordinate_handler)};this.change_gamestate=function(a,b){this.coordinate_handler=new Coordinate_handler(this.under_canvas,a,b);this.projector.resize(this.coordinate_handler,a)};this.toggle=function(a,
b){var c=this.coordinate_handler.y_i(b),d=this.coordinate_handler.x_j(a);c=this.get_gamestate().toggle(c,d);console.log(c);this.set_gamestate(c)};$(this.over_canvas).click(function(a){return c.toggle(a.offsetX,a.offsetY)});this.merge=function(a,b,c){c=this.coordinate_handler.y_i(c);b=this.coordinate_handler.x_j(b);this.set_gamestate(this.get_gamestate().merge(a,c,b))};this.project=function(){this.projector.project(this.get_gamestate())};this.toggle_grid=function(){this.grid.toggle()}}
var rle=function(){function a(a){var b=function(a){return 1===a},c=-1,d=-1,f=-1,k=-1;for(r_index=0;r_index<a.rows;r_index++)if(a.row(r_index).some(b)){c=r_index;break}for(r_index=a.rows-1;0<=r_index;r_index--)if(a.row(r_index).some(b)){f=r_index;break}for(c_index=0;c_index<a.cols;c_index++)if(a.col(c_index).some(b)){d=c_index;break}for(c_index=a.cols-1;0<=c_index;c_index--)if(a.col(c_index).some(b)){k=c_index;break}return a.rect(c,d,f,k)}function b(a){var b=a.match(/(\d*)([a-z])/);a={o:1,b:0}[b[2]];
b=b[1];if(""===b)return[a];b=parseInt(b);return Array(b).fill(a)}function c(a){if(""===a||"!"===a)return[];a=a.match(new RegExp(/(\d*[a-z])/,"g"));return flatmap(a,b)}function d(a){return a.replace(new RegExp(/(\d+)\$/,"g"),function(a,b){return"$".repeat(parseInt(b))})}function f(a,b,f){a=d(a).match(new RegExp(/\w*(\$|!)/,"g")).map(c);var k=a.map(function(a){return pad(a,0,b)});return new TDArray(a.length,b,function(a,b){return k[a][b]})}function g(a){a=a.match(new RegExp(/[B,b]\d*\/[S,s]\d*/));return new Rule(a[0])}
function h(a){a=a.split("\n");a=a.filter(function(a){return!a.match("^#")});var b=a[0];parseInt(b.match(new RegExp(/y\s*=\s*(\d*)/))[1]);var c=parseInt(b.match(new RegExp(/x\s*=\s*(\d*)/))[1]);b=g(b);a=f(a.slice(1).join(""),c,0);return{rule:b,gamestate:new GameState(a)}}function l(a){return a.map(function(a){return 0===a?"b":"o"}).join("").replace(new RegExp(/(.)\1+/,"g"),function(a,b){return String(a.length)+b}).replace(/\d*b*$/,function(){return"$"})}function m(a,b){var c=["x=",a.cols,", y=",a.rows,
", rule = ",b.string].join(""),d=a.row_map(l).join("");d=d.replace(/\$$/,"!");d=d.replace(new RegExp(/\$+/,"g"),function(a){return String(a.length)+"$"});return[c].concat(chunk(d,70)).join("\n")}return{encode:function(b,c,d){c=void 0===c?classic_rule:c;return void 0===d||d?m(a(b.cells),c):m(b.cells,c)},decode:function(a){return h(a)}}}(),state=makeObservable();state.rate=1E3;state.step_on=!1;state.grid_on=!1;state.cell_size=10;state.pattern=newEmptyGameState(30,30);state.gamestate=void 0;
state.rule=classic_rule;state.save_list=[];function toggle_step(){state.step_on=state.step_on?!1:!0}function toggle_grid(){state.grid_on=state.grid_on?!1:!0}function snapshot(){return{gamestate:state.gamestate,rule:state.rule}}function load_snapshot(a){state.gamestate=a.gamestate;state.rule=a.rule}function add_to_save_list(a){state.save_list.push(a);state.notify("save_list")}var gol_canvas=$(gol_canvas_id).get(0);state.gamestate=GameStateFromCanvas(gol_canvas,5);
var main_c_set=new Canvas_set(gol_canvas_id,10);main_c_set.initialize(state.gamestate,10,function(){return state.gamestate},function(a){return state.gamestate=a});$(main_c_set.over_canvas).unbind("click");$(main_c_set.over_canvas).click(function(a){a.shiftKey?main_c_set.merge(state.pattern,a.offsetX,a.offsetY):main_c_set.toggle(a.offsetX,a.offsetY)});state.addObserver("gamestate",main_c_set);state.addObserver("grid_on",main_c_set);state.addObserver("cell_size",main_c_set);
main_c_set.update=function(a){switch(a){case "gamestate":this.project();break;case "grid_on":this.toggle_grid();break;case "cell_size":this.coordinate_handler.resize(state.cell_size),this.projector.resize(this.coordinate_handler),this.grid.resize(state.cell_size)}};var stepper=new RateController(state.rate,function(){state.gamestate=apply_rule(state.rule,state.gamestate)});state.addObserver("rate",stepper);state.addObserver("step_on",stepper);
stepper.update=function(a){switch(a){case "rate":this.set_rate(state.rate);break;case "step_on":this.toggle()}};var pattern_c_set=new Canvas_set(pattern_canvas_id,10);pattern_c_set.initialize(state.pattern,10,function(){return state.pattern},function(a){return state.pattern=a});pattern_c_set.toggle_grid();state.addObserver("pattern",pattern_c_set);
pattern_c_set.update=function(a){switch(a){case "pattern":a=auto_cell_size(pattern_c_set.under_canvas,state.pattern),this.change_gamestate(state.pattern,a),this.grid.resize(a)}};$(rle_textarea_id).val(patterns.backrake_1);state.pattern=rle.decode(patterns.backrake_1).gamestate;var save_list={update:function(a){switch(a){case "save_list":addToSaveList(state.save_list[state.save_list.length-1])}}};state.addObserver("save_list",save_list);
function saveListElem(a,b){$(a).on("click",function(a){a.target===this&&$(b).slideToggle()});$(b).on("click",function(){e.target===this&&$(b).slideToggle()});var c=document.createElement("li");$(c).append(a);$(c).append(b);return c}function gamestateThumbnail(a){var b=a.cells.rows,c=a.cells.cols,d=document.createElement("canvas");d.height=b;d.width=c;b=new Coordinate_handler(d,a,1);c=new Projector(d);c.initialize(a,b);c.project(a);$(d).addClass("save_thumbail");return d}
function buttonSet(a){var b=document.createElement("span"),c=document.createElement("button");$(c).addClass("save_list_btn");c.innerHTML="LD";$(c).click(function(){load_snapshot(a)});var d=document.createElement("button");$(d).addClass("save_list_btn");d.innerHTML="RLE";$(d).click(function(){var a=rle.encode(state.gamestate,state.rule);rle_textarea.val(a)});$(b).append(d);$(b).append(c);return b}
function processSnapshot(a,b){var c=a.gamestate,d=a.rule.string,f=document.createElement("li");f.innerHTML=b+" Rule: "+d;$(f).addClass("save_list_upper");$(f).append(buttonSet(a));d=document.createElement("li");$(d).append(gamestateThumbnail(c));$(d).addClass("save_list_lower");return saveListElem(f,d)}var generateSaveId=function(){var a=0;return function(){var b="Save #"+String(a);a++;return b}}(),saveListId="#save-list";
function addToSaveList(a){$(saveListId).append(processSnapshot(a,generateSaveId()));return!0}$("#toggle_grid_btn").click(function(){return toggle_grid()});$("#soup_btn").click(function(){return state.gamestate=state.gamestate.soup()});$("#zoom-slider").on("input",function(){state.cell_size=this.value});$("#reset_btn").click(function(){return state.gamestate=state.gamestate.clear()});$("#toggle_step_btn").click(function(){return toggle_step()});$("#rate_slider").on("input",function(){state.rate=this.value});
var rle_textarea=$(rle_textarea_id);$("#rle_submit_btn").click(function(){var a=rle_textarea.val();a=rle.decode(a);state.pattern=a.gamestate});$("#rle_generate_btn").click(function(){var a=rle.encode(state.gamestate,state.rule);rle_textarea.val(a)});$("#save_btn").click(function(){add_to_save_list(snapshot())});
